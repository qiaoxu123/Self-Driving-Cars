WEBVTT

1
00:00:13.820 --> 00:00:17.510
Hi everyone and welcome
to our final video of

2
00:00:17.510 --> 00:00:19.070
the seventh module on

3
00:00:19.070 --> 00:00:21.545
motion planning for
self-driving cars.

4
00:00:21.545 --> 00:00:24.740
In this lesson, we'll be
introducing a method to generate

5
00:00:24.740 --> 00:00:26.450
a velocity profile for

6
00:00:26.450 --> 00:00:27.920
a given input path

7
00:00:27.920 --> 00:00:30.475
generated by our
path planning algorithm.

8
00:00:30.475 --> 00:00:32.770
If you recall from Module one,

9
00:00:32.770 --> 00:00:34.550
there are many
different factors that

10
00:00:34.550 --> 00:00:36.920
affect velocity
profile generation.

11
00:00:36.920 --> 00:00:38.900
In particular, we will focus on

12
00:00:38.900 --> 00:00:42.060
the reference velocity provided
by the behavior planner,

13
00:00:42.060 --> 00:00:45.350
the velocity of dynamic
obstacles in front of us,

14
00:00:45.350 --> 00:00:47.450
and the velocity
required to maintain

15
00:00:47.450 --> 00:00:50.120
passenger comfort and
vehicle stability.

16
00:00:50.120 --> 00:00:51.740
By the end of this video,

17
00:00:51.740 --> 00:00:53.090
you should be able to construct

18
00:00:53.090 --> 00:00:56.220
velocity profiles
along plan paths that

19
00:00:56.220 --> 00:00:58.669
take into account
reference velocities

20
00:00:58.669 --> 00:01:01.310
from different behavior
planning situations,

21
00:01:01.310 --> 00:01:02.840
time to collision to

22
00:01:02.840 --> 00:01:07.135
a leading dynamic obstacle,
and comfort constraints.

23
00:01:07.135 --> 00:01:09.725
Finally, you should
be able to implement

24
00:01:09.725 --> 00:01:12.065
a linear ramp velocity profile

25
00:01:12.065 --> 00:01:14.930
as well as a trapezoidal
velocity profile.

26
00:01:14.930 --> 00:01:16.865
So let's get started.

27
00:01:16.865 --> 00:01:19.145
The first step in generating

28
00:01:19.145 --> 00:01:20.600
a velocity profile is

29
00:01:20.600 --> 00:01:23.485
determining our final
required velocity.

30
00:01:23.485 --> 00:01:26.525
A good initial value
for our final velocity

31
00:01:26.525 --> 00:01:27.830
is the reference velocity

32
00:01:27.830 --> 00:01:29.945
given to us by
the behavior planner.

33
00:01:29.945 --> 00:01:33.380
This reference velocity will
largely be influenced by

34
00:01:33.380 --> 00:01:35.030
the maneuver that
the behavior plan

35
00:01:35.030 --> 00:01:38.345
selected based on
the current driving scenario.

36
00:01:38.345 --> 00:01:40.790
For example, if we are stopped at

37
00:01:40.790 --> 00:01:43.085
an intersection and
the light is still red,

38
00:01:43.085 --> 00:01:46.220
the behavior planner will
issue a stopped maneuver to

39
00:01:46.220 --> 00:01:48.305
the local planner
which will include

40
00:01:48.305 --> 00:01:50.810
outputting a zero
velocity reference.

41
00:01:50.810 --> 00:01:54.200
If we're currently driving
straight along a given road,

42
00:01:54.200 --> 00:01:55.970
the reference
velocity may just be

43
00:01:55.970 --> 00:01:58.250
the speed limit of
that current road.

44
00:01:58.250 --> 00:02:01.955
We will denote this by
V ref going forward.

45
00:02:01.955 --> 00:02:03.770
The next input we take into

46
00:02:03.770 --> 00:02:06.905
consideration are
the dynamic obstacle states.

47
00:02:06.905 --> 00:02:08.870
In particular, we focus on

48
00:02:08.870 --> 00:02:10.925
the lead vehicle in front of us.

49
00:02:10.925 --> 00:02:13.760
The lead vehicle speed
regulates our speed,

50
00:02:13.760 --> 00:02:15.890
because if we exceed
the lead vehicle speed,

51
00:02:15.890 --> 00:02:18.200
we will eventually
collide with it.

52
00:02:18.200 --> 00:02:20.870
Recall that the time
to collision is

53
00:02:20.870 --> 00:02:23.090
a function of
our relative velocity to

54
00:02:23.090 --> 00:02:26.090
the lead vehicle as well
as the length of the path

55
00:02:26.090 --> 00:02:29.270
to the lead vehicle
given by s. Therefore,

56
00:02:29.270 --> 00:02:31.730
to preserve a safe time
to collision,

57
00:02:31.730 --> 00:02:34.520
we will take our reference
velocity to be the minimum of

58
00:02:34.520 --> 00:02:35.840
the lead vehicle speed

59
00:02:35.840 --> 00:02:38.530
and the behavior plan
or reference speed.

60
00:02:38.530 --> 00:02:41.090
In addition, we need
to make sure that

61
00:02:41.090 --> 00:02:43.220
we are below
the lead vehicle speed

62
00:02:43.220 --> 00:02:45.799
before we reach
their current location

63
00:02:45.799 --> 00:02:48.530
for this planning iteration
because otherwise,

64
00:02:48.530 --> 00:02:51.215
we are still at risk for
colliding with them.

65
00:02:51.215 --> 00:02:54.560
In general, when dealing
with dynamic obstacles,

66
00:02:54.560 --> 00:02:57.110
it is good to leave
space and time buffers

67
00:02:57.110 --> 00:02:59.570
in our calculations for safety.

68
00:02:59.570 --> 00:03:02.555
Therefore, if the end
of our path lies

69
00:03:02.555 --> 00:03:05.560
ahead of the current position
of the lead vehicle,

70
00:03:05.560 --> 00:03:08.750
we need to make sure that
our final velocity is reached

71
00:03:08.750 --> 00:03:12.680
before that point including
leaving a spatial buffer,

72
00:03:12.680 --> 00:03:15.935
as shown here by
the red point along the path.

73
00:03:15.935 --> 00:03:17.400
By the time we reach

74
00:03:17.400 --> 00:03:19.630
the red point in
our velocity profile,

75
00:03:19.630 --> 00:03:22.460
we will need to have reached
the lead vehicle speed,

76
00:03:22.460 --> 00:03:24.410
if it is moving slower than us.

77
00:03:24.410 --> 00:03:26.150
The lead vehicle will move

78
00:03:26.150 --> 00:03:28.630
ahead by the time we reach
the current position.

79
00:03:28.630 --> 00:03:31.190
At that point, we will
have reached its speed

80
00:03:31.190 --> 00:03:34.250
preventing us from
colliding with it.

81
00:03:34.250 --> 00:03:36.080
Note that we can also take lead

82
00:03:36.080 --> 00:03:38.330
vehicle tracking one
step further and

83
00:03:38.330 --> 00:03:40.910
directly ensure
a safe time to collision

84
00:03:40.910 --> 00:03:44.150
or separation distance
given a lead vehicle speed,

85
00:03:44.150 --> 00:03:46.670
but this changes
the control function to

86
00:03:46.670 --> 00:03:48.455
a relative distance tracking

87
00:03:48.455 --> 00:03:50.600
from a relative
velocity tracking,

88
00:03:50.600 --> 00:03:52.340
so we'll stick to the velocity

89
00:03:52.340 --> 00:03:54.280
based approach in this video.

90
00:03:54.280 --> 00:03:56.690
The final input we consider is

91
00:03:56.690 --> 00:03:59.960
the maximum curvature
along our planned path.

92
00:03:59.960 --> 00:04:02.030
Recall from our last
lesson that when

93
00:04:02.030 --> 00:04:04.280
we sampled the optimized path,

94
00:04:04.280 --> 00:04:06.320
we record the curvature
of the spiral at

95
00:04:06.320 --> 00:04:09.100
each point denoted by capital I.

96
00:04:09.100 --> 00:04:11.790
In addition, we
mentioned in Module one,

97
00:04:11.790 --> 00:04:14.240
that there is a maximum
lateral acceleration

98
00:04:14.240 --> 00:04:17.660
required to remain inside
the comfort rectangle.

99
00:04:17.660 --> 00:04:20.180
The lateral acceleration
as a function of

100
00:04:20.180 --> 00:04:22.430
the instantaneous curvature as

101
00:04:22.430 --> 00:04:25.670
well as the longitudinal speed
along the curve.

102
00:04:25.670 --> 00:04:27.740
Therefore, the curvature bounds

103
00:04:27.740 --> 00:04:29.540
the longitudinal
velocity that we can

104
00:04:29.540 --> 00:04:31.790
take while traversing our path.

105
00:04:31.790 --> 00:04:35.180
We can enforce this by
ensuring the velocity stays

106
00:04:35.180 --> 00:04:38.495
below the required limit
at each point on the path.

107
00:04:38.495 --> 00:04:41.330
However, if the curvature
changes rapidly,

108
00:04:41.330 --> 00:04:44.450
we may not be able to achieve
the required velocity while

109
00:04:44.450 --> 00:04:47.975
remaining within our longitudinal
acceleration bounds.

110
00:04:47.975 --> 00:04:49.880
We therefore also find

111
00:04:49.880 --> 00:04:52.340
the maximum curvature
across all points in

112
00:04:52.340 --> 00:04:54.110
our path and then find

113
00:04:54.110 --> 00:04:57.095
the associated maximum speed
for that point.

114
00:04:57.095 --> 00:04:59.090
Our profile must then reach

115
00:04:59.090 --> 00:05:02.345
this required speed by
the point in the path.

116
00:05:02.345 --> 00:05:04.940
We therefore define
a deceleration to

117
00:05:04.940 --> 00:05:06.380
the required speed at

118
00:05:06.380 --> 00:05:09.885
the minimum point and
an acceleration afterward.

119
00:05:09.885 --> 00:05:11.720
We can repeat this process for

120
00:05:11.720 --> 00:05:13.160
the next largest violation

121
00:05:13.160 --> 00:05:14.720
of the curvature
constraint and so

122
00:05:14.720 --> 00:05:16.760
on until the velocity profile

123
00:05:16.760 --> 00:05:20.475
satisfies the curvature
constraints along its length.

124
00:05:20.475 --> 00:05:23.720
A simpler approach that is
useful for the assessments in

125
00:05:23.720 --> 00:05:27.445
this course is to identify
the maximum curvature point,

126
00:05:27.445 --> 00:05:29.655
set the associated speed,

127
00:05:29.655 --> 00:05:31.010
and then simply maintain

128
00:05:31.010 --> 00:05:33.245
that speed until
we pass the point.

129
00:05:33.245 --> 00:05:35.030
Since we are continuously

130
00:05:35.030 --> 00:05:37.955
re-planning in
a receding horizon manner,

131
00:05:37.955 --> 00:05:40.400
once the high curvature
point is reached,

132
00:05:40.400 --> 00:05:43.610
the new velocity profiles
generated will naturally

133
00:05:43.610 --> 00:05:45.200
raise the speed based on

134
00:05:45.200 --> 00:05:47.605
the other objectives
defined earlier.

135
00:05:47.605 --> 00:05:50.090
In essence, we can simplify

136
00:05:50.090 --> 00:05:52.265
the velocity profile
generation process

137
00:05:52.265 --> 00:05:53.944
to the act of combining

138
00:05:53.944 --> 00:05:56.600
our curvature-based
maximum speed with

139
00:05:56.600 --> 00:05:58.580
our previous two
maximum speeds from

140
00:05:58.580 --> 00:06:01.160
the behavior planner
and the lead vehicle by

141
00:06:01.160 --> 00:06:03.365
taking the minimum of all three

142
00:06:03.365 --> 00:06:06.475
as the desired final velocity
of our profile.

143
00:06:06.475 --> 00:06:08.660
Next, we need to discuss what

144
00:06:08.660 --> 00:06:11.420
the shape of our velocity
profile is going to be.

145
00:06:11.420 --> 00:06:13.580
One possible simple option is

146
00:06:13.580 --> 00:06:15.650
to generate a linear ramp profile

147
00:06:15.650 --> 00:06:17.210
from our current velocity to

148
00:06:17.210 --> 00:06:20.435
our desired final velocity
that we calculated earlier.

149
00:06:20.435 --> 00:06:22.430
When planning our profile,

150
00:06:22.430 --> 00:06:24.935
we know the total arc
length of our path,

151
00:06:24.935 --> 00:06:28.265
denoted s, and our initial
and final speed.

152
00:06:28.265 --> 00:06:30.230
The first thing we
need to calculate

153
00:06:30.230 --> 00:06:31.970
is our required acceleration,

154
00:06:31.970 --> 00:06:35.150
which we can solve for directly
with our given inputs.

155
00:06:35.150 --> 00:06:37.100
We have to be careful to ensure

156
00:06:37.100 --> 00:06:39.185
that this calculated acceleration

157
00:06:39.185 --> 00:06:41.495
doesn't exceed
our comfort rectangle

158
00:06:41.495 --> 00:06:44.255
as we discussed
earlier in the course.

159
00:06:44.255 --> 00:06:47.179
If it does exceed
the comfort rectangle,

160
00:06:47.179 --> 00:06:49.325
then we will need to clamp it.

161
00:06:49.325 --> 00:06:53.060
If an acceleration or
deceleration is required that

162
00:06:53.060 --> 00:06:54.710
exceeds the comfort rectangle

163
00:06:54.710 --> 00:06:56.959
but is required due
to safety concerns,

164
00:06:56.959 --> 00:06:59.690
such as during
an emergency stop maneuver,

165
00:06:59.690 --> 00:07:01.400
then we can bypass

166
00:07:01.400 --> 00:07:04.400
this comfort rectangle
to prevent a crash.

167
00:07:04.400 --> 00:07:06.860
If we do clamp our acceleration,

168
00:07:06.860 --> 00:07:08.930
then we need to update
our final velocity

169
00:07:08.930 --> 00:07:11.405
accordingly using
our maximum acceleration,

170
00:07:11.405 --> 00:07:14.855
a max, instead of
our calculated acceleration, a.

171
00:07:14.855 --> 00:07:17.539
Once we have our
acceleration profile,

172
00:07:17.539 --> 00:07:20.540
we can then calculate
the velocity at each point along

173
00:07:20.540 --> 00:07:24.035
the path by looking at the arc
length to the ith point.

174
00:07:24.035 --> 00:07:26.270
By iterating through
the entire path and

175
00:07:26.270 --> 00:07:29.120
calculating the required
velocity for each point,

176
00:07:29.120 --> 00:07:31.760
we have completely generated
a velocity profile

177
00:07:31.760 --> 00:07:35.105
along our path to get to
our desired end velocity.

178
00:07:35.105 --> 00:07:38.930
An alternative profile is
the trapezoidal profile.

179
00:07:38.930 --> 00:07:41.930
It's useful when a car is
approaching a stop sign,

180
00:07:41.930 --> 00:07:45.050
and we want to decelerate
from our nominal speed to

181
00:07:45.050 --> 00:07:46.970
a lower transit speed before then

182
00:07:46.970 --> 00:07:50.030
decelerating again to
a stop at the stop sign.

183
00:07:50.030 --> 00:07:51.980
For this velocity profile,

184
00:07:51.980 --> 00:07:54.140
we take as our input,
our initial,

185
00:07:54.140 --> 00:07:57.845
and final velocities,
our desired transit velocity,

186
00:07:57.845 --> 00:08:00.310
and our desired deceleration.

187
00:08:00.310 --> 00:08:03.890
This deceleration is usually
chosen to be well within

188
00:08:03.890 --> 00:08:05.360
our comfort rectangle to make

189
00:08:05.360 --> 00:08:08.030
the profile as
smooth as possible.

190
00:08:08.030 --> 00:08:10.700
The first step with
this planner is to

191
00:08:10.700 --> 00:08:12.560
calculate the distance
we will travel

192
00:08:12.560 --> 00:08:14.645
during our initial deceleration

193
00:08:14.645 --> 00:08:16.655
to our desired transit speed.

194
00:08:16.655 --> 00:08:18.080
This is the arc length

195
00:08:18.080 --> 00:08:19.790
traveled during
the first segment of

196
00:08:19.790 --> 00:08:21.800
the trapezoidal profile and is

197
00:08:21.800 --> 00:08:25.195
given by the first
equation here for Sa.

198
00:08:25.195 --> 00:08:28.250
From this, we know
how much arc length along

199
00:08:28.250 --> 00:08:29.480
our initial path should be

200
00:08:29.480 --> 00:08:32.015
dedicated to our
initial deceleration.

201
00:08:32.015 --> 00:08:34.550
The parameters for
this initial calculation

202
00:08:34.550 --> 00:08:36.110
include our initial speed,

203
00:08:36.110 --> 00:08:38.180
vi, the transit speed,

204
00:08:38.180 --> 00:08:42.270
vt, and our gentle
deceleration value, a naught.

205
00:08:42.270 --> 00:08:44.590
Once we have this arc
length value,

206
00:08:44.590 --> 00:08:46.265
we can iterate through the points

207
00:08:46.265 --> 00:08:48.260
up to that arc length and use

208
00:08:48.260 --> 00:08:50.180
the second equation
shown to calculate

209
00:08:50.180 --> 00:08:52.610
the required speed
for the ith point.

210
00:08:52.610 --> 00:08:55.070
We can then repeat
a similar process for

211
00:08:55.070 --> 00:08:56.750
the final deceleration from

212
00:08:56.750 --> 00:09:00.095
the transit velocity to
rest at our stopped point.

213
00:09:00.095 --> 00:09:03.890
We will denote the entire arc
length of our path as Sf.

214
00:09:03.890 --> 00:09:05.460
So the third segment of

215
00:09:05.460 --> 00:09:08.820
our profile has
length Sf minus Sb.

216
00:09:08.820 --> 00:09:12.015
We can then solve
for Sb as follows.

217
00:09:12.015 --> 00:09:14.060
Once we have Sb, we can

218
00:09:14.060 --> 00:09:15.530
then iterate through
the points in

219
00:09:15.530 --> 00:09:17.990
this arc length range
and assign them

220
00:09:17.990 --> 00:09:19.550
the required velocities for

221
00:09:19.550 --> 00:09:22.100
a gentle deceleration to a stop.

222
00:09:22.100 --> 00:09:24.020
The remaining points
in the middle of

223
00:09:24.020 --> 00:09:26.540
the profile then take
our constant transit speed,

224
00:09:26.540 --> 00:09:29.990
v sub t. Putting
everything together,

225
00:09:29.990 --> 00:09:32.690
we have three regions in
our velocity profile;

226
00:09:32.690 --> 00:09:36.215
an initial ramp down to
our slow transit speed,

227
00:09:36.215 --> 00:09:38.855
a constant traversal
at this transit speed,

228
00:09:38.855 --> 00:09:41.780
and a final ramp down
to our stop point.

229
00:09:41.780 --> 00:09:43.970
We've shown you
two methods here for

230
00:09:43.970 --> 00:09:46.070
generating a velocity profile,

231
00:09:46.070 --> 00:09:48.785
but there are many other options
available as well.

232
00:09:48.785 --> 00:09:50.900
Using higher-order methods such

233
00:09:50.900 --> 00:09:53.285
as biquadratic velocity planners,

234
00:09:53.285 --> 00:09:56.300
we can minimize jerk along
the trajectory as well.

235
00:09:56.300 --> 00:09:58.370
It's also possible to apply

236
00:09:58.370 --> 00:10:01.130
higher-order functions
in our velocity ramp in

237
00:10:01.130 --> 00:10:03.860
the two methods we've
shown here, which can

238
00:10:03.860 --> 00:10:07.615
generate smoother and more
comfortable velocity profiles.

239
00:10:07.615 --> 00:10:10.160
Ultimately, velocity profiles can

240
00:10:10.160 --> 00:10:13.700
be optimized to meet multiple
objectives simultaneously

241
00:10:13.700 --> 00:10:16.835
while satisfying comfort
and safety constraints

242
00:10:16.835 --> 00:10:19.415
depending on the behavior
to be executed.

243
00:10:19.415 --> 00:10:22.519
In developing a velocity
profile generator

244
00:10:22.519 --> 00:10:24.149
for the final assessment,

245
00:10:24.149 --> 00:10:26.540
you should feel free
to expand on any of

246
00:10:26.540 --> 00:10:27.860
the concepts discussed in

247
00:10:27.860 --> 00:10:30.065
this video, as seems appropriate.

248
00:10:30.065 --> 00:10:32.630
To summarize, in this video,

249
00:10:32.630 --> 00:10:34.400
we discussed how to incorporate

250
00:10:34.400 --> 00:10:36.560
the output reference
velocity from

251
00:10:36.560 --> 00:10:38.300
our behavior planner into

252
00:10:38.300 --> 00:10:41.015
our velocity profile
generation process.

253
00:10:41.015 --> 00:10:43.430
We also discussed how
to use the time to

254
00:10:43.430 --> 00:10:46.870
collision to inform
our velocity profile generation,

255
00:10:46.870 --> 00:10:48.230
and we incorporated

256
00:10:48.230 --> 00:10:50.725
lateral acceleration
constraints as well.

257
00:10:50.725 --> 00:10:52.550
Finally, we discussed how to

258
00:10:52.550 --> 00:10:54.979
calculate linear ramp
and trapezoidal

259
00:10:54.979 --> 00:10:57.230
velocity profiles to implement

260
00:10:57.230 --> 00:10:59.930
velocity transitions
along a path.

261
00:10:59.930 --> 00:11:03.800
This completes the seventh
module on motion planning.

262
00:11:03.800 --> 00:11:06.450
Let's summarize the main points.

263
00:11:06.450 --> 00:11:09.830
You first learn to work with
two kinds of curves for

264
00:11:09.830 --> 00:11:13.085
path planning;
splines and spirals.

265
00:11:13.085 --> 00:11:15.200
You then define
the objectives and

266
00:11:15.200 --> 00:11:17.000
constraints needed to formulate

267
00:11:17.000 --> 00:11:18.395
the path planning problem.

268
00:11:18.395 --> 00:11:22.325
You developed experience
with the psi pi optimize

269
00:11:22.325 --> 00:11:24.200
function and applied it to

270
00:11:24.200 --> 00:11:25.700
a conformal lattice planner

271
00:11:25.700 --> 00:11:28.195
to identify collision-free paths.

272
00:11:28.195 --> 00:11:30.680
Finally, you learned
how to construct

273
00:11:30.680 --> 00:11:32.660
the velocity profile along

274
00:11:32.660 --> 00:11:35.540
the path to satisfy
multiple constraints.

275
00:11:35.540 --> 00:11:37.640
You should now have
enough knowledge to

276
00:11:37.640 --> 00:11:39.410
integrate a path planner and

277
00:11:39.410 --> 00:11:41.660
velocity profile planner to build

278
00:11:41.660 --> 00:11:44.315
your very own local planner
from the ground up.

279
00:11:44.315 --> 00:11:46.250
You'll learn more about this in

280
00:11:46.250 --> 00:11:47.390
the final project in

281
00:11:47.390 --> 00:11:50.370
the next module.
We'll see you there.